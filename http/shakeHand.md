# 三次握手与四次挥手

三次握手、四次挥手
所谓三次握手是指在建立tcp连接时，客户端和服务器之前来回发送三个包。

为什么需要三次握手
为了确认双方的接收与发送能力是否正常

6个标志位
SYN 发送/同步标志，用来建立连接
ACK 确认标志，表示收到请求
PSH 表示推送操作
FIN 结束标志，用于结束tcp会话
RST 重置标志
URG 紧急标志

2个序号
sequence number(seq) 顺序号
acknowledge number(ack) 确认号，响应前面的seq， ack = seq + 1

三次握手过程
第一次握手：客户端发送数据包（SYN=1，seq=x）给服务器，客户端进入SYN_SENT状态，服务器接收到数据包，由SYN=1判断出需要建立连接
第二次握手：服务器发送数据包（SYN=1，ACK=1，seq=y，ack=x+1），表示收到了客户端的请求，需要客户端再次确认。服务器进入SYN_RCVD状态。
第三次握手：客户端收到服务器发送的数据包，对数据进行确认。确认后发送数据包（ACK=1，seq=x+1，ack=y+1）。服务端收到后进行确认ack与ACK，建立连接。客户端和服务器进入ESTABLISHED状态


在服务器进行完第二次握手，即发送完SYN-ACK包后，在第三次握手进行之前的tcp连接成为半连接


四次挥手过程
第一次挥手：客户端发送数据包（FIN=1，seq=m）给服务器，进入FIN_WAIT1状态
第二次挥手：服务器收到释放连接报文，发送确认报文（ACK=1，ack=m+1，seq=n），服务器进入CLOSE_WAIT状态。客户端收到服务器的确认报文后，进入FIN_WAIT2状态
第三次挥手：因为服务器可能会还有数据需要发送。等数据发送完毕后，才会向客户端发送释放报文（FIN=1，ack=m+1，seq=q），服务器进入LAST_ACK状态
第四次挥手：客户端收到服务器的释放报文，向服务器发送确认报文（ACK=1，ack=q+1，seq=m+1）。此时客户端进入TIME_WAIT状态。此时的tcp连接仍未释放，需要等待2*MSL(2倍的最大报文生存时间)后，如果没有继续从服务器收到释放报文，才进入CLOSED状态，释放连接。而服务器只要收到了客户端的确认，就释放连接了。可以看到，服务器的释放比客户端较早。

状态 listen establish 
syn ack 

fin ack 

2mls

tcp通过什么机制确保可靠性
ack 超时重传 滑动窗口 流量控制