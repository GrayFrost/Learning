# 三次握手与四次挥手

所谓三次握手是指在建立tcp连接时，客户端和服务器之前来回发送三个包。

## 标识符号
6个标志位：
* SYN 发送/同步标志，用来建立连接
* ACK 确认标志，表示收到请求
* PSH 表示推送操作
* FIN 结束标志，用于结束tcp会话
* RST 重置标志
* URG 紧急标志

2个序号：
* sequence number(seq) 顺序号
* acknowledge number(ack) 确认号，响应前面的seq， ack = seq + 1

## 三次握手过程
第一次握手：客户端发送数据包（SYN=1，seq=x）给服务器，客户端进入SYN_SENT状态，服务器接收到数据包，由SYN=1判断出需要建立连接
第二次握手：服务器发送数据包（SYN=1，ACK=1，seq=y，ack=x+1），表示收到了客户端的请求，需要客户端再次确认。服务器进入SYN_RCVD状态。
第三次握手：客户端收到服务器发送的数据包，对数据进行确认。确认后发送数据包（ACK=1，seq=x+1，ack=y+1）。服务端收到后进行确认ack与ACK，建立连接。客户端和服务器进入ESTABLISHED状态


在服务器进行完第二次握手，即发送完SYN-ACK包后，在第三次握手进行之前的tcp连接成为半连接


## 四次挥手过程
第一次挥手：客户端发送数据包（FIN=1，seq=m）给服务器，进入FIN_WAIT1状态
第二次挥手：服务器收到释放连接报文，发送确认报文（ACK=1，ack=m+1，seq=n），服务器进入CLOSE_WAIT状态。客户端收到服务器的确认报文后，进入FIN_WAIT2状态
第三次挥手：因为服务器可能会还有数据需要发送。等数据发送完毕后，才会向客户端发送释放报文（FIN=1，ack=m+1，seq=q），服务器进入LAST_ACK状态
第四次挥手：客户端收到服务器的释放报文，向服务器发送确认报文（ACK=1，ack=q+1，seq=m+1）。此时客户端进入TIME_WAIT状态。此时的tcp连接仍未释放，需要等待2*MSL(2倍的最大报文生存时间)后，如果没有继续从服务器收到释放报文，才进入CLOSED状态，释放连接。而服务器只要收到了客户端的确认，就释放连接了。可以看到，服务器的释放比客户端较早。

## 问题
1. 为什么需要三次握手，两次不行吗？
为了确认双方的接收与发送能力是否正常。
同时为了防止已失效的连接请求报文发送到服务器，从而产生错误。有一种场景，由于网络原因，客户端发送的请求连接太长时间没有达到服务器，于是重传，然后两次握手建立连接。然后此前发送的报文由于网络畅通了达到服务器，服务器建立连接。然而对于客户端来说，这个连接请求已经失效。这边导致了连接资源的浪费。

2. 为什么连接是三次握手，关闭是四次挥手？
建立连接时，服务器可以直接向客户端发送SYN+ACK。
TCP是全双工模式，当客户端向服务器发送FIN，只表示客户端结束发送，服务器可能还没还送完数据，所以服务器不会立刻发送FIN，只会先发送确认包。

3. SYN攻击
SYN攻击就是客户端伪造大量不存在的IP地址，然后向服务器发送SYN包，服务器回复确认包后，由于是虚假的ip客户端，因此不会进行确认处理。服务器便不断的进行重传处理直至超时，大量伪造的SYN包便占用了连接队列，往往导致正常的SYN包被丢弃。

3. 为什么要等待2MSL？
如果最后一次发送确认包丢包了，服务器会在超时之后重发FIN包

tcp通过什么机制确保可靠性
ack 超时重传 滑动窗口 流量控制